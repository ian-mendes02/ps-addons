!function(h,i,y){window.ps??={},window.ps.inline_edit={},h("tr[data-discount-id]").each(function(){let a=h(this),o="edit"==a.attr("data-row-action"),e=o?a.attr("data-discount-id"):"ps-new-discount",s=o?i.find(i=>i.id==e):null,c="inline-edit-"+e,n={edit:a.find("a[data-action=edit]"),copy:a.find("a[data-action=copy]"),delete:a.find("a[data-action=delete]"),toggle:a.find('[name="discount_active"]')},t=i=>0==i.slice(-1)&&JSON.parse(i.slice(0,-1)),d=(i,e)=>JSON.stringify(i)==JSON.stringify(e);function l(){window.ps.inline_edit.data=w();var i=h("#"+c).find("[data-action=save]"),e=window.ps.inline_edit,e=!d(e._data,e.data);return e?i.removeClass("ps-disabled"):i.addClass("ps-disabled"),e}function p(){for(var i=h(this).closest("li"),e=i.attr("id"),n=window.ps.inline_edit.data.included_products,t=0;t<n.length;t++)n[t].id==e&&(window.ps.inline_edit.data.included_products.splice(t,1),i.remove(),l())}function r(i){var n,t=h("#"+c).find("ul.ps-selected-products");for(let e of i)window.ps.inline_edit.included_products.find(i=>i.id==e.id)||(n='<li class="ps-included-product" id="'+e.id+'"><span>'+e.name+"</span></li>",t.append(h(n).prepend(h('<span class="ps-remove-selected-product"></span>').on("click",p))),window.ps.inline_edit.included_products.push(e));l()}function u(){var i=h(this).val(),n=h("#"+c+" .ps-products-dropdown");i.length<2?n.empty().hide():h.post(y,{action:"product_lookup",query:i,limit:5},function(i){if(i&&0!=i.length){for(var e of t(i))n.append(function(i){var e='<li class="ps-list-item ps-product-option" data-product-id="'+i.id+'">'+i.name+"</li>";return h(e).on("click",()=>r([i]))}(e));n.show()}else 0==i.length&&n.empty()})}let f=i=>{"Enter"==i.key&&v(),"Escape"==i.key&&_()};function v(){var i;l()&&((i=window.ps.inline_edit.data).is_active=!o||n.toggle.hasClass("active")?1:0,i.name&&""!=i.name?h.post(y,{action:"submit_discount",data:i},function(i){i=t(i);1!=i?"error"==i.status&&alert(i.message):location.reload()}):alert("O campo 'Nome' não pode ficar em branco."))}function _(){h(document).off("keydown",f),h("#ps-new-discount-header").remove(),h("#"+c).siblings("tr.hidden").addBack().remove(),a.show()}function m(){var i=h("#"+c);return window.ps.inline_edit.fields??={name:i.find('[name="discount_name"]'),type:i.find('[name="discount_type"]'),value:i.find('[name="discount_value"]'),schedule:i.find('[name="discount_expires_on"]'),priority:i.find('[name="discount_priority"]')},window.ps.inline_edit.fields}function w(){var i=m();return{id:e,name:i.name.val(),type:i.type.val(),value:i.value.val(),schedule:i.schedule.val().replace("T"," "),priority:i.priority.val(),included_products:window.ps.inline_edit.included_products}}n.copy.on("click",()=>h.post(y,{action:"duplicate_discount",id:e},()=>location.reload())),n.edit.on("click",function(){h("tr[data-discount-id]").each(function(){h('[id^="inline-edit-"]').siblings("tr.hidden").addBack().remove(),h(this).show().removeClass("active")}),window.ps.inline_edit={},window.ps.inline_edit.included_products=[],a.addClass("active");var i=h("#ps-inline-edit").clone(!0),e=(a.hide().after(i).after('<tr class="hidden"></tr>'),o||a.before(h('<h2 id="ps-new-discount-header">Novo Desconto</h2>')),i.attr("id",c),i.find("td").attr("colspan",h("#ps-discounts-list-table thead th").length),m()),n=(o&&(e.name.val(s.name),e.type.find(`option[value="${s.type}"]`).attr("selected","selected"),e.value.val(s.value),e.priority.val(s.priority),e.schedule.val(s.expires_on.replace(" ","T"))),i.find(".ps-products-dropdown")),t=i.find('[name="product_name"]'),d=(i.find("input[name]:not(.product-name-input)").on("input",l),i.find("select").on("change",l),t.on("input",u),t.on("focus",()=>n.show()),e.type.on("change",function(){"percent"!=h(this).val()?e.value.attr("max",""):(100<e.value.val()&&e.value.val(100),e.value.attr("max","100"))}),e.value.on("change",function(){var i=h(this);"percent"==e.type.val()&&100<i.val()&&i.val(100)}),h(document).on("click",function(i){i=h(i.target);i.parent().is(n)||i.is(t)||i.is(n)||(n.hide(),t.val(""))}),o?s.included_products:[]);window.ps.inline_edit._data=w(),r(window.ps.inline_edit._data.included_products=d),i.find("[data-action=save]").on("click",v),i.find("[data-action=cancel]").on("click",_),h(document).on("keydown",f)}),n.delete.on("click",()=>{var i;confirm("Excluir o item?\n(Essa ação não pode ser desfeita)")&&(i={action:"delete_discount",id:e},h.post(y,i,()=>location.reload()))}),n.toggle.on("click",function(){var i=h(this);i.toggleClass("active"),h.post(y,{action:"update_discount_status",id:e,is_active:i.hasClass("active")?1:0})})}),h(".ps-tooltip").on("mouseenter",function(){h(this).find("p").show()}),h(".ps-tooltip").on("mouseleave",function(){h(this).find("p").hide()})}(jQuery,ps_ajax.discount_data,ps_ajax.ajax_url);